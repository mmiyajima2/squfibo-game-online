# =============================================================================
# Nginx 設定テンプレート - squfibo-online.buntozu.com
#
# 【構成】
#   - クライアント (静的ファイル): /path/to/squfibo-game-online/client/dist
#   - サーバー (APIおよびSocket.IO): http://localhost:3000
#   - SSL: Let's Encrypt (certbot によって自動設定 ── 仮置き)
#
# 【導入手順】
#   1. このファイルを /etc/nginx/sites-available/squfibo-online.conf にコピー
#   2. DOCUMENT_ROOT を実際のパスに書き換える
#   3. sudo ln -s /etc/nginx/sites-available/squfibo-online.conf \
#              /etc/nginx/sites-enabled/squfibo-online.conf
#   4. sudo certbot --nginx -d squfibo-online.buntozu.com  (SSL取得後は不要)
#   5. sudo nginx -t && sudo systemctl reload nginx
# =============================================================================

# HTTP → HTTPS リダイレクト
server {
    listen 80;
    listen [::]:80;
    server_name squfibo-online.buntozu.com;

    # Let's Encrypt の証明書更新用 (certbot が使用)
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$host$request_uri;
    }
}

# HTTPS メインサーバー
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    server_name squfibo-online.buntozu.com;

    # ----------------------------------------------------------------
    # SSL 証明書 (Let's Encrypt / certbot が発行・更新)
    # certbot --nginx 実行後に自動で書き換えられる仮置きパス
    # ----------------------------------------------------------------
    ssl_certificate     /etc/letsencrypt/live/squfibo-online.buntozu.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/squfibo-online.buntozu.com/privkey.pem;
    include             /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam         /etc/letsencrypt/ssl-dhparams.pem;

    # ----------------------------------------------------------------
    # クライアント静的ファイル
    # DOCUMENT_ROOT を実際のビルド済みパスに変更すること
    # 例: /home/deploy/squfibo-game-online/client/dist
    # ----------------------------------------------------------------
    root /path/to/squfibo-game-online/client/dist;
    index index.html;

    # SPA のフォールバック (React Router 対応)
    location / {
        try_files $uri $uri/ /index.html;
    }

    # ----------------------------------------------------------------
    # サーバー API (REST)
    # /api/* をバックエンド (port 3000) へ転送
    # ----------------------------------------------------------------
    location /api/ {
        proxy_pass         http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
    }

    # ----------------------------------------------------------------
    # Socket.IO (WebSocket)
    # /socket.io/* をバックエンド (port 3000) へ転送
    # ----------------------------------------------------------------
    location /socket.io/ {
        proxy_pass         http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header   Upgrade           $http_upgrade;
        proxy_set_header   Connection        "upgrade";
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;

        # WebSocket のタイムアウト設定
        proxy_read_timeout  86400s;
        proxy_send_timeout  86400s;
    }

    # ----------------------------------------------------------------
    # セキュリティヘッダー
    # ----------------------------------------------------------------
    add_header X-Frame-Options       "SAMEORIGIN"   always;
    add_header X-Content-Type-Options "nosniff"     always;
    add_header X-XSS-Protection      "1; mode=block" always;
    add_header Referrer-Policy       "strict-origin-when-cross-origin" always;

    # ----------------------------------------------------------------
    # 静的アセットのキャッシュ設定
    # ----------------------------------------------------------------
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff2?)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }

    # ログ
    access_log /var/log/nginx/squfibo-online.access.log;
    error_log  /var/log/nginx/squfibo-online.error.log;
}
