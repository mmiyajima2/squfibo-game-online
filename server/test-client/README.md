# SquFibo ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ

ã“ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã¯ã€Socket.IOã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ãŸã‚ã®æ±ç”¨çš„ãªãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

## ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

### ãƒ–ãƒ©ã‚¦ã‚¶ãƒ™ãƒ¼ã‚¹ã®ãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«
- **test-driver.html** - æ±ç”¨ã‚¤ãƒ™ãƒ³ãƒˆãƒ†ã‚¹ãƒˆãƒ‰ãƒ©ã‚¤ãƒãƒ¼ï¼ˆæ¨å¥¨ï¼‰
  - å…¨ã¦ã®Socket.IOã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ†ã‚¹ãƒˆã§ãã‚‹çµ±åˆãƒ„ãƒ¼ãƒ«
  - ã‚¤ãƒ™ãƒ³ãƒˆé¸æŠã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å…¥åŠ›ã€çµæœè¡¨ç¤ºã‚’å‚™ãˆãŸGUI

- **index.html** - éƒ¨å±‹ä½œæˆå°‚ç”¨ãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«ï¼ˆãƒ¬ã‚¬ã‚·ãƒ¼ï¼‰
  - `createRoom`ã‚¤ãƒ™ãƒ³ãƒˆå°‚ç”¨ã®æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³
  - ç°¡æ˜“çš„ãªãƒ†ã‚¹ãƒˆã«ã¯å¼•ãç¶šãä½¿ç”¨å¯èƒ½

### Node.jsãƒ™ãƒ¼ã‚¹ã®ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
- **test-event-generic.js** - æ±ç”¨ã‚¤ãƒ™ãƒ³ãƒˆãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆæ¨å¥¨ï¼‰
  - ã©ã®ã‚¤ãƒ™ãƒ³ãƒˆã§ã‚‚ãƒ†ã‚¹ãƒˆã§ãã‚‹æ±ç”¨CLIãƒ„ãƒ¼ãƒ«
  - ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‹ã‚‰ä»»æ„ã®ã‚¤ãƒ™ãƒ³ãƒˆ+ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’é€ä¿¡å¯èƒ½

- **test-create-room.js** - éƒ¨å±‹ä½œæˆå°‚ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
  - `createRoom`ã‚¤ãƒ™ãƒ³ãƒˆå°‚ç”¨

- **test-join-room.js** - éƒ¨å±‹å‚åŠ å°‚ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
  - `joinRoom`ã‚¤ãƒ™ãƒ³ãƒˆå°‚ç”¨

- **test-validation.js** - ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

## ğŸš€ ä½¿ã„æ–¹

### äº‹å‰æº–å‚™

1. ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¾ã™:
   ```bash
   cd server
   npm run dev
   ```

2. RedisãŒèµ·å‹•ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™:
   ```bash
   redis-cli ping
   # "PONG" ãŒè¿”ã£ã¦ãã‚Œã° OK
   ```

### æ–¹æ³•1: æ±ç”¨ãƒ†ã‚¹ãƒˆãƒ‰ãƒ©ã‚¤ãƒãƒ¼ï¼ˆæ¨å¥¨ï¼‰

ãƒ–ãƒ©ã‚¦ã‚¶ã§ **test-driver.html** ã‚’é–‹ãã¾ã™:

```bash
cd server/test-client
npx http-server -p 8080
```

ãã®å¾Œã€ãƒ–ãƒ©ã‚¦ã‚¶ã§ `http://localhost:8080/test-driver.html` ã‚’é–‹ãã¾ã™

#### ä½¿ã„æ–¹
1. ã‚µãƒ¼ãƒãƒ¼URLã‚’ç¢ºèªï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: `http://localhost:3000`ï¼‰
2. ãƒ†ã‚¹ãƒˆã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’é¸æŠ
3. å¿…è¦ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å…¥åŠ›
4. ã€Œã‚¤ãƒ™ãƒ³ãƒˆã‚’å®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
5. çµæœãŒJSONå½¢å¼ã§è¡¨ç¤ºã•ã‚Œã¾ã™

#### å¯¾å¿œã‚¤ãƒ™ãƒ³ãƒˆ
- âœ… **createRoom** - æ–°ã—ã„éƒ¨å±‹ã‚’ä½œæˆ
- âœ… **joinRoom** - æ—¢å­˜ã®éƒ¨å±‹ã«å‚åŠ 
- ğŸš§ **ready** - æº–å‚™å®Œäº†ï¼ˆæœªå®Ÿè£…ï¼‰
- ğŸš§ **removeCard** - ã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤ï¼ˆæœªå®Ÿè£…ï¼‰
- ğŸš§ **claimCombo** - ã‚³ãƒ³ãƒœã‚’å®£è¨€ï¼ˆæœªå®Ÿè£…ï¼‰
- ğŸš§ **endTurn** - ã‚¿ãƒ¼ãƒ³çµ‚äº†ï¼ˆæœªå®Ÿè£…ï¼‰
- ğŸš§ **leaveRoom** - éƒ¨å±‹ã‹ã‚‰é€€å‡ºï¼ˆæœªå®Ÿè£…ï¼‰

### æ–¹æ³•2: Node.jsæ±ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

ä»»æ„ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ†ã‚¹ãƒˆã§ãã¾ã™:

```bash
cd server/test-client

# createRoomã‚’ãƒ†ã‚¹ãƒˆ
node test-event-generic.js createRoom '{"playerName":"ãƒ›ã‚¹ãƒˆ"}'

# joinRoomã‚’ãƒ†ã‚¹ãƒˆ
node test-event-generic.js joinRoom '{"roomId":"550e8400-e29b-41d4-a716-446655440000","playerName":"ã‚²ã‚¹ãƒˆ"}'
```

### æ–¹æ³•3: ã‚¤ãƒ™ãƒ³ãƒˆå°‚ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

#### éƒ¨å±‹ã‚’ä½œæˆã™ã‚‹
```bash
cd server/test-client
node test-create-room.js
```

çµæœä¾‹:
```json
{
  "roomId": "550e8400-e29b-41d4-a716-446655440000",
  "playerId": "7c9e6679-7425-40de-944b-e07fc1f90ae7",
  "hostUrl": "http://localhost:5173/room/550e8400-e29b-41d4-a716-446655440000?role=host",
  "guestUrl": "http://localhost:5173/room/550e8400-e29b-41d4-a716-446655440000?role=guest",
  "expiresAt": "2024-01-01T12:13:00.000Z"
}
```

#### éƒ¨å±‹ã«å‚åŠ ã™ã‚‹
```bash
cd server/test-client
node test-join-room.js <roomId> [playerName]
```

ä¾‹:
```bash
# roomIdã‚’æŒ‡å®šã—ã¦å‚åŠ 
node test-join-room.js "550e8400-e29b-41d4-a716-446655440000" "ã‚²ã‚¹ãƒˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼"
```

çµæœä¾‹:
```json
{
  "roomId": "550e8400-e29b-41d4-a716-446655440000",
  "playerId": "8d1f8790-8536-51ef-a55c-f18fd2g01bf8",
  "role": "guest",
  "roomInfo": {
    "hostPlayerName": "ãƒ›ã‚¹ãƒˆ",
    "guestPlayerName": "ã‚²ã‚¹ãƒˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼",
    "status": "WAITING"
  }
}
```

## âœ… ç¢ºèªäº‹é …

### createRoomã‚¤ãƒ™ãƒ³ãƒˆ
- [x] Socket.IOã‚µãƒ¼ãƒãƒ¼ã¸ã®æ¥ç¶š
- [x] `createRoom`ã‚¤ãƒ™ãƒ³ãƒˆã®é€ä¿¡
- [x] `roomCreated`ã‚¤ãƒ™ãƒ³ãƒˆã®å—ä¿¡
- [x] Redisã¸ã®ãƒ‡ãƒ¼ã‚¿ä¿å­˜
- [x] ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- [x] ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®è¡¨ç¤º

### joinRoomã‚¤ãƒ™ãƒ³ãƒˆ
- [x] `joinRoom`ã‚¤ãƒ™ãƒ³ãƒˆã®é€ä¿¡
- [x] `roomJoined`ã‚¤ãƒ™ãƒ³ãƒˆã®å—ä¿¡
- [x] `playerJoined`ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ
- [x] éƒ¨å±‹ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
- [x] æº€å®¤ãƒã‚§ãƒƒã‚¯
- [x] éƒ¨å±‹æƒ…å ±ã®æ›´æ–°

## ğŸ” Redisãƒ‡ãƒ¼ã‚¿ã®ç¢ºèª

ä½œæˆã•ã‚ŒãŸéƒ¨å±‹ã®ãƒ‡ãƒ¼ã‚¿ã¯Redisã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ç¢ºèªã§ãã¾ã™:

```bash
# å…¨ã¦ã®ã‚­ãƒ¼ã‚’è¡¨ç¤º
redis-cli KEYS "room:*"

# ç‰¹å®šã®éƒ¨å±‹ã®æƒ…å ±ã‚’å–å¾—
redis-cli GET "room:{roomId}:info"

# éƒ¨å±‹æƒ…å ±ã‚’æ•´å½¢ã—ã¦è¡¨ç¤º
redis-cli GET "room:{roomId}:info" | jq .

# TTLã‚’ç¢ºèªï¼ˆæ®‹ã‚Šæœ‰åŠ¹æ™‚é–“ï¼‰
redis-cli TTL "room:{roomId}:info"
```

éƒ¨å±‹æƒ…å ±ã®æ§‹é€ :
```json
{
  "roomId": "550e8400-e29b-41d4-a716-446655440000",
  "hostPlayerId": "7c9e6679-7425-40de-944b-e07fc1f90ae7",
  "hostPlayerName": "ãƒ›ã‚¹ãƒˆ",
  "guestPlayerId": "8d1f8790-8536-51ef-a55c-f18fd2g01bf8",
  "guestPlayerName": "ã‚²ã‚¹ãƒˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼",
  "hostSocketId": "abc123",
  "guestSocketId": "def456",
  "createdAt": "2024-01-01T12:00:00.000Z",
  "expiresAt": "2024-01-01T12:13:00.000Z",
  "status": "WAITING"
}
```

## ğŸ§ª ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªä¾‹

### ã‚·ãƒŠãƒªã‚ª1: éƒ¨å±‹ä½œæˆã‹ã‚‰å‚åŠ ã¾ã§

1. ã‚¿ãƒ¼ãƒŸãƒŠãƒ«1ã§ãƒ›ã‚¹ãƒˆãŒéƒ¨å±‹ã‚’ä½œæˆ:
   ```bash
   node test-create-room.js
   # roomIdã‚’ã‚³ãƒ”ãƒ¼
   ```

2. ã‚¿ãƒ¼ãƒŸãƒŠãƒ«2ã§ã‚²ã‚¹ãƒˆãŒå‚åŠ :
   ```bash
   node test-join-room.js "<roomId>" "ã‚²ã‚¹ãƒˆ"
   ```

3. ä¸¡æ–¹ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèª

### ã‚·ãƒŠãƒªã‚ª2: ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ã®ãƒ†ã‚¹ãƒˆ

```bash
# å­˜åœ¨ã—ãªã„éƒ¨å±‹ã«å‚åŠ 
node test-join-room.js "invalid-room-id" "ã‚²ã‚¹ãƒˆ"
# ã‚¨ãƒ©ãƒ¼: ROOM_NOT_FOUND

# æº€å®¤ã®éƒ¨å±‹ã«å‚åŠ ï¼ˆ3äººç›®ï¼‰
node test-join-room.js "<full-room-id>" "3äººç›®"
# ã‚¨ãƒ©ãƒ¼: ROOM_FULL

# ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åãŒé•·ã™ãã‚‹
node test-event-generic.js createRoom '{"playerName":"ã“ã‚Œã¯21æ–‡å­—ã‚’è¶…ãˆã‚‹éå¸¸ã«é•·ã„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã§ã™"}'
# ã‚¨ãƒ©ãƒ¼: INVALID_PLAYER_NAME
```

## ğŸ›  ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ããªã„

- ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„
- ã‚µãƒ¼ãƒãƒ¼ã®ãƒãƒ¼ãƒˆãŒ3000ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„
- CORSè¨­å®šãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„

### Redisã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹

- RedisãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„:
  ```bash
  redis-cli ping
  ```
- Redis URLãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: `redis://localhost:6379`ï¼‰

### ã‚¤ãƒ™ãƒ³ãƒˆãŒå¤±æ•—ã™ã‚‹

- ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼ˆé–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ï¼‰ã§ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„
- ã‚µãƒ¼ãƒãƒ¼ã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„
- ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒæ­£ã—ã„å½¢å¼ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„

### ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãŒç™ºç”Ÿã™ã‚‹

- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„
- ã‚µãƒ¼ãƒãƒ¼ãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„
- ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå€¤ã‚’å¢—ã‚„ã™å¿…è¦ãŒã‚ã‚‹å ´åˆã¯ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®æœ€å¾Œã®`setTimeout`å€¤ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„

## ğŸ“ ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

### ã‚µãƒ¼ãƒãƒ¼URLå¤‰æ›´

ç’°å¢ƒå¤‰æ•°ã§æŒ‡å®šã§ãã¾ã™:

```bash
SERVER_URL=http://localhost:4000 node test-create-room.js
```

### ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚é–“å¤‰æ›´

å„ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®æœ€å¾Œã«ã‚ã‚‹`setTimeout`ã®å€¤ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„:

```javascript
setTimeout(() => {
  console.error('\nâ° Timeout - no response from server');
  socket.disconnect();
  process.exit(1);
}, 10000); // â† ã“ã®å€¤ã‚’å¤‰æ›´ï¼ˆãƒŸãƒªç§’ï¼‰
```

## ğŸ”— é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [Socket.IO Event Specification](../docs/design/socket-io-event-spec.md)
- [Redis Data Structure](../docs/design/redis-data-structure.md)
