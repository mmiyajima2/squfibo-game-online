# SquFibo オンライン版 E2Eテスト仕様書

## 1. 概要

本仕様書は、SquFibo オンライン版のエンドツーエンド（E2E）テストの対象範囲、テストシナリオ、検証項目を定義する。

### 1.1 対象システム

- **クライアント**: React + Vite SPA（`http://localhost:5173`）
- **サーバー**: Express.js + Socket.IO（`http://localhost:3000`）
- **データベース**: Redis（`localhost:6379`）

### 1.2 テスト対象外

- 単体テスト済みのゲームロジック（`Game.test.ts`、`ComboDetector.test.ts` 等）
- 内部のサービス層ユニットテスト

---

## 2. テスト環境

### 2.1 必要な環境

| コンポーネント | バージョン | 起動コマンド |
|---|---|---|
| Redis | 6.x 以上 | `redis-server` |
| サーバー | - | `npm run dev`（server/ ディレクトリ） |
| クライアント | - | `npm run dev`（client/ ディレクトリ） |

### 2.2 テストブラウザ

- Chrome（最新安定版）を基準とする
- 2プレイヤーのシナリオでは、2つのブラウザウィンドウ（またはシークレットモード）を使用する

### 2.3 前提条件

- Redisが起動していること
- サーバーがポート 3000 で起動していること
- クライアントがポート 5173 で起動していること

---

## 3. テストシナリオ一覧

| ID | カテゴリ | シナリオ名 |
|---|---|---|
| TC-01 | ウェルカム画面 | 画面表示確認 |
| TC-02 | ウェルカム画面 | 部屋数の表示 |
| TC-03 | 部屋作成 | 正常な部屋作成 |
| TC-04 | 部屋作成 | 部屋上限時のエラー |
| TC-05 | 部屋参加 | ゲストが正常に参加 |
| TC-06 | 部屋参加 | 存在しない部屋IDで参加失敗 |
| TC-07 | ゲーム開始 | 両プレイヤー準備完了でゲーム開始 |
| TC-08 | ターン基本 | カード配置とターン交代 |
| TC-09 | ターン基本 | 手札ゼロ時のドロー |
| TC-10 | 盤面満杯 | カード破棄してから配置 |
| TC-11 | 役申告 | 大役（1+4+16）の申告と解決 |
| TC-12 | 役申告 | 小役（同数3枚）の申告と解決 |
| TC-13 | 役申告 | 役の未申告でターン終了 |
| TC-14 | ゲーム終了 | 星がすべて獲得されてゲーム終了 |
| TC-15 | ゲーム終了 | 山札0枚でゲーム終了 |
| TC-16 | 切断・再接続 | 30秒以内に再接続して継続 |
| TC-17 | 切断・タイムアウト | 30秒後に相手の勝利 |
| TC-18 | 退出 | ゲーム中の退出処理 |
| TC-19 | エラー処理 | 無効な操作に対するエラー表示 |
| TC-20 | マニュアル | マニュアルページの表示 |

---

## 4. テストシナリオ詳細

### TC-01: ウェルカム画面の表示確認

**目的**: ウェルカム画面が正しく表示されること

**手順**:
1. ブラウザで `http://localhost:5173` を開く

**期待結果**:
- 「SquFibo」のタイトルが表示される
- 「オンライン版を開始する」ボタンが表示される
- 「ブラウザ版」への外部リンクが表示される
- 「マニュアル」へのリンクが表示される
- [x] OK

---

### TC-02: ウェルカム画面の部屋数表示

**目的**: 現在の部屋数が正しく表示されること

**手順**:
1. ブラウザで `http://localhost:5173` を開く
2. 部屋数の表示エリアを確認する

**期待結果**:
- ページ上に部屋数（例: `現在のゲーム部屋: 0 / 89`）が表示される
- ページ読み込み後、`/api/rooms/count` の結果が反映される
- [x] OK

---

### TC-03: 正常な部屋作成

**目的**: ホストが部屋を作成してゲーム待機状態になること

**手順**:
1. ウェルカム画面で「オンライン版を開始する」ボタンをクリックする
2. 部屋作成ダイアログが表示される
3. プレイヤー名（例: `テストホスト`）を入力する
4. 作成ボタンをクリックする

**期待結果**:
- ゲーム画面（`/game?role=host&...`）に遷移する
- ゲスト招待用URLが表示される
- 「ゲストの参加を待っています」などの待機メッセージが表示される
- URLにroomId、playerId、playerNameが含まれる

- [x] OK

---

### TC-04: 部屋上限時のエラー

**目的**: 部屋数が89室に達した場合、作成がエラーになること

**前提条件**: Redisに89室分のデータが存在する（モック or 直接投入）

**手順**:
1. 部屋作成ダイアログでプレイヤー名を入力して作成ボタンをクリックする

**期待結果**:
- エラーメッセージが表示される（例: 「部屋が満室です」または同等のメッセージ）
- ゲーム画面に遷移しない

- [ ] TODO

---

### TC-05: ゲストが正常に参加

**目的**: ゲストが招待URLを開いて部屋に参加できること

**前提条件**: TC-03が完了しており、招待URLが取得済み

**手順**:
1. 別のブラウザウィンドウ（またはシークレットモード）で招待URL（ゲスト用URL）を開く
2. 参加ダイアログが表示される
3. プレイヤー名（例: `テストゲスト`）を入力する
4. 参加ボタンをクリックする

**期待結果**:
- ゲーム画面（`/game?role=guest&...`）に遷移する
- ホスト側の画面でゲスト参加が通知される（例: 「テストゲスト が参加しました」）
- 両プレイヤーの名前が画面に表示される

- [x] OK

---

### TC-06: 存在しない部屋IDで参加失敗

**目的**: 無効な部屋IDでアクセスした際にエラーになること

**手順**:
1. ブラウザで `http://localhost:5173/game?role=guest&roomId=invalid-room-id&playerName=テスト` を開く

**期待結果**:
- エラーメッセージが表示される（例: 「部屋が見つかりません」）
- ゲームが開始しない

- [x] OK

---

### TC-07: 両プレイヤー準備完了でゲーム開始

**目的**: 両プレイヤーが準備完了にするとゲームが始まること

**前提条件**: TC-05が完了しており、両プレイヤーがゲーム画面にいる

**手順**:
1. ホスト側でスタートボタン（または準備ボタン）をクリックする
2. ゲスト側でスタートボタン（または準備ボタン）をクリックする

**期待結果**:
- 両プレイヤーの画面でゲームが開始される
- 各プレイヤーの手札が配布される（初期手札枚数分）
- 盤面（3×3グリッド）が空の状態で表示される
- 先手プレイヤーのターンである旨が表示される
- 星数（各プレイヤー 0、合計21個が場に）が表示される

- [x] OK

---

### TC-08: カード配置とターン交代

**目的**: アクティブプレイヤーがカードを配置してターンが交代すること

**前提条件**: TC-07が完了しており、ゲームが進行中

**手順**:
1. 先手（アクティブ）プレイヤーの画面で手札からカードを1枚選択する
2. 盤面の空きマスをクリックしてカードを配置する
3. 役を申告せずにターン終了ボタンをクリックする

**期待結果**:
- 選択したカードが指定のマスに表示される
- 先手プレイヤーの手札から1枚減る
- ターンが後手プレイヤーに移る
- 後手プレイヤーの操作が有効になる（先手は操作不可になる）

- [x] OK

---

### TC-09: 手札ゼロ時のドロー

**目的**: 手札が0枚の場合、山札から自動でドローされること

**前提条件**: ゲームが進行中で、対象プレイヤーの手札が0枚の状態を作る

**手順**:
1. 手札が0枚の状態でそのプレイヤーのターンを迎える

**期待結果**:
- 山札から1枚ドローされ、手札に加わる
- その後、通常通りカードを配置できる
- 山札枚数が1枚減る

- [ ] TODO

---

### TC-10: 盤面満杯時のカード破棄と配置

**目的**: 盤面が9枚で満杯の場合、先にカードを破棄してから配置できること

**前提条件**: ゲームが進行中で、盤面が9枚のカードで埋まっている状態

**手順**:
1. アクティブプレイヤーの盤面が満杯状態になる
2. 盤面上の任意のカードをクリックして破棄を選択する
3. 手札からカードを1枚選択して空きマスに配置する

**期待結果**:
- 破棄操作でカードが盤面から除去される
- 空きマスに新しいカードを配置できる
- ゲームログに破棄操作が記録される

- [ ] TODO

---

### TC-11: 大役（1+4+16）の申告と解決

**目的**: 大役が成立し、申告するとカード除去・ドロー・星獲得が正しく処理されること

**前提条件**: ゲームが進行中で、盤面に 1、4、16 の同色カード3枚が縦/横/L字型に並んでいる、またはカード配置で大役が成立する状況

**手順**:
1. アクティブプレイヤーが役を成立させるカードを配置する
2. 役申告ボタン（または自動表示されるダイアログ）で役を申告する
3. 役を構成する3枚のカードを選択する（UI上で選択が必要な場合）

**期待結果**:
- 役を構成する3枚のカードが盤面から除去される
- アクティブプレイヤーが山札から3枚ドローする
- アクティブプレイヤーが星を3個獲得する（画面の星カウントが+3される）
- ゲームログに大役の成立が記録される
- ターンが相手プレイヤーに移る

- [x] OK

---

### TC-12: 小役（同数3枚）の申告と解決

**目的**: 小役が成立し、申告するとカード除去・ドロー・星獲得が正しく処理されること

**前提条件**: ゲームが進行中で、盤面に同じ数字の同色カード3枚が縦/横/L字型に並んでいる、またはカード配置で小役が成立する状況

**手順**:
1. アクティブプレイヤーが役を成立させるカードを配置する
2. 役申告ボタンで役を申告する

**期待結果**:
- 役を構成する3枚のカードが盤面から除去される
- アクティブプレイヤーが山札から1枚ドローする
- アクティブプレイヤーが星を1個獲得する（画面の星カウントが+1される）
- ゲームログに小役の成立が記録される
- ターンが相手プレイヤーに移る

- [x] OK

---

### TC-13: 役の未申告でターン終了

**目的**: 役が成立していても申告せずにターン終了できること

**前提条件**: ゲームが進行中で、盤面に役が成立している状態でカードを配置できる

**手順**:
1. アクティブプレイヤーがカードを配置する（役が成立する配置）
2. 役を申告せずにターン終了ボタンをクリックする

**期待結果**:
- 役は解決されない（星獲得なし、カード除去なし）
- ターンが相手プレイヤーに移る
- ゲームログにターン終了が記録される

- [x] OK

---

### TC-14: 星がすべて獲得されてゲーム終了

**目的**: 21個の星がすべて獲得されたときゲームが正常に終了すること

**前提条件**: ゲームが進行中で、残り星数が少ない（1〜3個）状態

**手順**:
1. 役を申告して残りの星をすべて獲得する

**期待結果**:
- 「ゲーム終了」画面またはメッセージが両プレイヤーに表示される
- 勝者（多くの星を獲得したプレイヤー）が正しく表示される
- 最終スコア（各プレイヤーの星数）が表示される
- 引き分け条件（同点）の場合は引き分けと表示される

- [ ] TODO

---

### TC-15: 山札0枚でゲーム終了

**目的**: 山札が0枚になったときゲームが正常に終了すること

**前提条件**: 山札の枚数が残り1〜2枚の状態

**手順**:
1. ゲームを進行させ、山札の最後の1枚がドローされる状態にする
2. 最後のドローが発生する操作（ターン開始時のドロー、役解決時のドロー）を行う

**期待結果**:
- 「ゲーム終了」画面またはメッセージが両プレイヤーに表示される
- 終了理由（山札切れ）が表示される
- 獲得星数が多いプレイヤーが勝者として表示される

- [ ] TODO

---

### TC-16: 30秒以内の再接続

**目的**: プレイヤーが切断後30秒以内に再接続すると、ゲームが継続されること

**前提条件**: ゲームが進行中

**手順**:
1. 一方のプレイヤーのブラウザタブを閉じる（または一時的にネットワークを切断する）
2. 相手プレイヤーの画面に切断通知が表示されることを確認する
3. 切断から30秒以内に同じURLでブラウザを再度開く

**期待結果**:
- 切断通知が相手プレイヤーに表示される（例: 「相手が切断しました。30秒以内に再接続を待っています」）
- 再接続後、ゲーム状態が復元される
- ゲームが中断前の状態から継続できる

- [ ] TODO

---

### TC-17: 30秒超の切断による相手プレイヤーの勝利

**目的**: プレイヤーが30秒以上切断したままの場合、相手プレイヤーの勝利になること

**前提条件**: ゲームが進行中

**手順**:
1. 一方のプレイヤーのブラウザを閉じる
2. 30秒以上経過するまで待つ

**期待結果**:
- 残ったプレイヤーの画面に「相手プレイヤーが退出しました。あなたの勝利です」などのメッセージが表示される
- ゲームが終了状態になる
- [ ] TODO

---

### TC-18: ゲーム中の退出処理

**目的**: プレイヤーが退出ボタンを押すと、相手に通知されてゲームが終了すること

**前提条件**: ゲームが進行中

**手順**:
1. ゲーム画面のヘッダーにある退出ボタンをクリックする
2. 確認ダイアログが表示された場合は退出を確認する

**期待結果**:
- 退出したプレイヤーはウェルカム画面に遷移する
- 相手プレイヤーの画面に「相手が退出しました」と通知される
- Redisから部屋データが削除される（間接的に確認: 部屋数が1減る）

- [x] TODO

---

### TC-19: 無効な操作に対するエラー表示

**目的**: アクティブでないプレイヤーが操作しようとした場合にエラーになること

**前提条件**: ゲームが進行中で、プレイヤーAのターン

**手順**:
1. プレイヤーB（非アクティブ）の画面でカード配置を試みる（UIが許可している場合）

**期待結果**:
- 操作が拒否される
- エラーメッセージが表示される（例: 「相手のターンです」）
- ゲーム状態は変化しない

---

### TC-20: マニュアルページの表示

**目的**: マニュアルページが正しく表示されること

**手順**:
1. ウェルカム画面の「マニュアル」リンクをクリックする

**期待結果**:
- `/manual` ページに遷移する
- ゲームのルール説明が表示される
- ウェルカム画面に戻るリンクが存在する

---

## 5. 画面別チェックリスト

### 5.1 ウェルカム画面

- [ ] タイトル「SquFibo」が表示される
- [ ] ゲーム説明文が表示される
- [ ] 「オンライン版を開始する」ボタンが動作する
- [ ] 「ブラウザ版」外部リンクが正しいURLを持つ
- [ ] 「マニュアル」リンクが `/manual` に遷移する
- [ ] 現在の部屋数が表示される（`X / 89`形式）

### 5.2 部屋作成ダイアログ

- [ ] プレイヤー名入力フィールドが表示される
- [ ] プレイヤー名が空の場合、作成ボタンが無効または送信不可
- [ ] プレイヤー名が21文字以上の場合、入力制限またはエラーが出る
- [ ] 作成成功後、ゲーム画面に遷移する

### 5.3 部屋参加ダイアログ（ゲスト）

- [ ] プレイヤー名入力フィールドが表示される
- [ ] 参加成功後、ゲーム画面に遷移する

### 5.4 ゲーム画面（待機中）

- [ ] ホスト名が表示される
- [ ] ゲスト参加待ちの場合、招待URLが表示される（ホスト側のみ）
- [ ] ゲストが参加したら招待URLが非表示になる
- [ ] スタート/準備ボタンが表示される

### 5.5 ゲーム画面（進行中）

- [ ] 3×3の盤面グリッドが表示される
- [ ] 各プレイヤーの手札が表示される（自分の手札のみ操作可能）
- [ ] 各プレイヤーの星数が表示される
- [ ] 現在のターンが明示される
- [ ] 山札の残り枚数が表示される
- [ ] アクティブプレイヤーのみカード操作ができる
- [ ] 役申告ボタンが適切なタイミングで表示される
- [ ] ターン終了ボタンが表示される
- [ ] 退出ボタンがヘッダーに表示される
- [ ] ゲームログ（コメンタリー）が更新される

### 5.6 ゲーム終了画面

- [ ] 勝者または引き分けが表示される
- [ ] 各プレイヤーの最終星数が表示される
- [ ] 終了理由（星獲得完了 / 山札切れ）が表示される
- [ ] ウェルカム画面に戻るボタンが表示される

---

## 6. 非機能テスト項目

### 6.1 レスポンシブ対応

- ウェルカム画面がモバイル（375px幅）で表示が崩れないこと
- ゲーム画面が主要な画面サイズ（375px, 768px, 1280px）で動作すること

### 6.2 通信遅延

- サーバー側に意図的に遅延を入れた場合でも、操作がブロックされないこと
- 通信中のローディング表示があること

### 6.3 部屋のTTL

- 部屋作成後13分（780秒）が経過したら、部屋が失効すること
- 失効後に操作した場合、適切なエラーが返ること

---

## 7. テストデータ

### 7.1 有効なプレイヤー名

| 値 | 説明 |
|---|---|
| `テスト` | 日本語、最短 |
| `TestPlayer` | 英字 |
| `あいうえおかきくけこさしすせそたちつてとな` | 20文字（上限） |

### 7.2 無効なプレイヤー名

| 値 | 説明 | 期待エラー |
|---|---|---|
| `` | 空文字 | 入力必須エラー |
| `あいうえおかきくけこさしすせそたちつてとな1` | 21文字（上限超過） | 文字数超過エラー |

---

## 8. 自動化ツール候補

E2Eテストの自動化には以下のツールを推奨する。

| ツール | 特徴 | 採用理由 |
|---|---|---|
| **Playwright** | Microsoft製、マルチブラウザ対応、Socket.IO通信との親和性が高い | 複数ウィンドウのシナリオ（2プレイヤー）が扱いやすい |
| Cypress | シングルドメイン向け、デバッグが容易 | 2ウィンドウシナリオには追加設定が必要 |

### 8.1 Playwright 使用時の注意点

- 2プレイヤーシナリオでは `browser.newContext()` で独立したコンテキストを2つ作成する
- Socket.IOの接続確立を待つため、`waitForEvent` や `waitForSelector` を適切に使用する
- Redis を各テスト前後にフラッシュして状態をリセットする

---

## 9. 改訂履歴

| バージョン | 日付 | 変更内容 |
|---|---|---|
| 1.0.0 | 2026-02-18 | 初版作成 |
