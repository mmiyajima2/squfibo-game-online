Task
----

# [x] 現在のゲーム部屋数をウエルカム画面にだしたい
- ゲームの仕様として、最大89部屋を制限にしてるため
- サーバからのデータ取得はSocket.ioでなくてもよいとおもっている
- まずは、この見出しのサブ見出しに設計方針を記載してほしい

## Claudeの意見

### 設計方針

**取得方法: REST API（`GET /api/rooms/count`）**

Socket.ioを使わず、シンプルなREST APIで部屋数を取得する。

#### サーバー側の変更

1. **RoomService.ts に `getRoomCount()` を追加**
   - RedisのSCANコマンドで `room:*:info` パターンのキーを数える
   - `KEYS` コマンドは本番環境では非推奨なので `SCAN` を使う

2. **app.ts に `GET /api/rooms/count` エンドポイントを追加**
   - `{ count: number, max: 89 }` を返す

#### クライアント側の変更

3. **Welcome.tsx でページ表示時に1回 `fetch` する**
   - `useEffect` でマウント時にAPIを叩く
   - `"現在 X / 89 部屋が使用中"` のような表示を追加
   - 30秒ごとのポーリングも追加してリアルタイム性を確保（任意）

#### データフロー
```
Welcome.tsx (マウント時)
  → fetch('/api/rooms/count')
  → Express endpoint
  → RoomService.getRoomCount()
  → Redis SCAN 'room:*:info'
  → count を返す
  → UI に表示
```

#### 実装ファイル
- `server/src/services/RoomService.ts` - getRoomCount() 追加
- `server/src/app.ts` - /api/rooms/count エンドポイント追加
- `client/src/pages/Welcome.tsx` - 部屋数表示 UI 追加

**完了**: ウェルカム画面に部屋数表示を実装しました
- `RoomService.getRoomCount()`: Redis SCANで `room:*:info` キーを数える
- `GET /api/rooms/count`: `{ count, max: 89 }` を返すREST APIエンドポイント追加
- `Welcome.tsx`: マウント時にfetch、30秒ごとにポーリング、`現在 X / 89 部屋が使用中` を表示

# [x] 退出ボタンをおした後の処理を改善してほしい
- お互いが部屋から退出するようにしてほしい
- redisの該当部屋のキーを削除してほしい
- **完了**: 退出後の処理を改善しました
  - サーバー: `handleLeaveRoom` で `io.to(roomId).emit('playerLeft', ...)` に変更し、退出したプレイヤー自身にも通知
  - サーバー: `RoomService.deleteRoom(roomId)` でRedisのルーム情報とゲーム状態キーを削除
  - クライアント: `useOnlineGame.ts` に `playerLeft` イベントリスナーを追加し、相手退出時に `onOpponentLeft` コールバックを呼び出す
  - クライアント: `Game.tsx` に `handleOpponentLeft` を追加し、localStorage クリアと Welcome ページへの遷移を実装

# [x] ゲーム画面で、退出ボタンが欲しい
- 退出ボタンは上のメニュー領域がよい
- leaveRoom イベントをコールする実装とする
- **完了**: オンラインモード時に退出ボタンを実装しました
  - useOnlineGame.tsにleaveRoom関数を追加
  - GameContainer.tsxのヘッダー部分に退出ボタンを追加（オンラインモードのみ表示）
  - Game.tsxでleaveRoom呼び出し後、Welcomeページに遷移する処理を追加
  - 退出時にlocalStorageもクリアするように実装

# [x] バグ: 上側が、赤9のL字で役を申告したが、解決効果がおかしい
- 3枚除去はうまくいってる
- 手札が1枚増えるもうまくいってる
- が、星の数が上側と下側の両プレイヤーに入っている表示になってる
- **完了**: GameStatus.tsxの星表示を修正しました
  - currentPlayer/opponentではなく、game.players[0]とgame.players[1]を直接参照するように変更
  - これにより、オンライン/オフライン両モードで正しくプレイヤーの星が表示されるようになりました

# [x] お互い準備完了したが、先攻後攻を示すメッセージや表示がおかしい
- お互い部屋にはいった状態で
- ゲストがまず準備完了を送信する
- 次にホストが準備完了を送信する
- ホスト側の下側手札が有効になっている
- なのに、画面したのログには上のプレイヤー（ゲスト）のターンとでる
- ボードの左横には、ゲストの名前のターンとでる
- ホスト側が先攻が実態なので、おかしい
- **完了**: ターン表示の問題を修正しました
  - GameContainer.tsx: オンラインモードでインデックスベースでターン判定するよう修正
  - GameContainer.tsx: ターン切り替えメッセージをオフラインモードのみに限定
  - GameStatus.tsx: 現在のターン表示をオンラインモード対応に修正
  - GameStatus.tsx: 勝者表示もオンラインモード対応に修正
  - オンライン/オフライン両モードで正しくターンと先攻後攻が表示されるようになりました

# [x] 役の成立を申告すして、claimCombo、を呼び出す処理を実装してほしい
- カードをそれぞれのプレイヤーが配置する処理はできた
- 役が成立してれば、解決・効果の発生まで実装してほしい
- 役が間違いなら、エラーメッセージを出すようにしてほしい
- **完了**: 役の申告処理を完全に実装しました
  - クライアント側で役の検証とclaimCombo呼び出しを実装（GameContainer.tsx）
  - サーバー側で役の検証と解決処理を実装（socket/index.ts）
  - 役が成立した場合: カード除去、星獲得、カードドロー、実況メッセージ表示
  - 役が間違いの場合: エラーメッセージを表示
  - オンライン/オフライン両モードで正常に動作

# [x] ウエルカムページ、ライトモード・白基調にしてほしい
- 色味の変更だけお願いしたい
- **完了**: Welcome.cssを白基調のライトモードに変更しました
  - 背景を白〜薄いグレーのグラデーションに変更
  - テキストカラーをダークグレーに変更
  - ボタンを青系の配色に統一
  - すべての要素を白基調に合わせて調整

# [x] 後攻がカード配置、ターン終了の動作を実装してほしい
- 先攻がカード配置->ターン終了は完成している
- 後攻でも同様にしてほしい
- **完了**: オンラインモードで先攻・後攻のターン判定を追加し、自分のターンの時だけ操作できるように実装しました
  - `isMyTurn`ロジックを追加（ホスト=先攻、ゲスト=後攻）
  - すべての操作関数にターンチェックを追加
  - UI要素のdisabled制御を強化


# [x] ボード左のパネル、ターンの表示がプレイヤー名になるようにしてほしい
- 現在は上側でいうと「CPU」となっている
- **完了**: GameStatusコンポーネントを修正し、オンラインモードではプレイヤー名、オフラインモードでは「下側」「上側」と表示されるようにしました